import spidev
import time
import board
import digitalio
import adafruit_character_lcd.character_lcd_i2c as character_lcd

# Setup for MCP3008 and SPI
spi = spidev.SpiDev()
spi.open(0, 0)  # SPI bus 0, device (CS) 0
spi.max_speed_hz = 1350000

# LCD setup
i2c = board.I2C()  # Using I2C-3
lcd_columns = 16
lcd_rows = 2
lcd = character_lcd.Character_LCD_I2C(i2c, lcd_columns, lcd_rows)

# Setup for LEDs
red_led = digitalio.DigitalInOut(board.D5)
red_led.direction = digitalio.Direction.OUTPUT
blue_led = digitalio.DigitalInOut(board.D6)
blue_led.direction = digitalio.Direction.OUTPUT

# Define methane sensor channel
MQ4_CHANNEL = 0  # Connected to channel 0 on MCP3008

# Function to read data from MCP3008 ADC
def read_adc(channel):
    if channel > 7 or channel < 0:
        return -1
    adc = spi.xfer2([1, (8 + channel) << 4, 0])
    data = ((adc[1] & 3) << 8) + adc[2]
    return data

# Function to calculate methane concentration in ppm
def calculate_methane_ppm(adc_value):
    voltage = (adc_value * 3.3) / 1023  # Convert ADC value to voltage
    ppm = voltage * 100  # Adjust based on sensor calibration
    return ppm

# Main function to monitor methane levels
def detect_spoilage():
    try:
        while True:
            # Read methane level
            adc_value = read_adc(MQ4_CHANNEL)
            ppm = calculate_methane_ppm(adc_value)
            
            # Display methane level on LCD
            lcd.clear()
            lcd.message = f"Methane: {ppm:.2f} ppm"
            print(f"Methane Level: {ppm:.2f} ppm")  # For debugging

            # Control LEDs based on ppm threshold
            if ppm > 200:  # Example threshold for spoilage
                red_led.value = True  # Turn on red LED for high methane
                blue_led.value = False
                lcd.message += "\nSpoilage detected!"
                print("Warning: Spoilage detected!")
            else:
                red_led.value = False
                blue_led.value = True  # Turn on blue LED for safe levels
                lcd.message += "\nStatus: Safe"
            
            time.sleep(1)
    except KeyboardInterrupt:
        spi.close()
        print("Program terminated")

# Run the spoilage detection function
detect_spoilage()
